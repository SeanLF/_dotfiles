#!/bin/bash
# Wait for network connectivity
#
# Usage: online [-q] [-h] [timeout]
#   -q, --quiet   Silent mode (exit code only, no output or notification)
#   -h, --help    Show this help message
#   timeout       Seconds to wait (default: 60)
#
# Exit codes:
#   0  Connected
#   1  Timed out

set -e

show_help() {
  sed -n '2,10s/^# \{0,1\}//p' "$0"
  exit 0
}

quiet=false
timeout=60

while [[ $# -gt 0 ]]; do
  case "$1" in
    -q|--quiet) quiet=true; shift ;;
    -h|--help) show_help ;;
    -*) echo "Unknown option: $1" >&2; exit 1 ;;
    *) timeout="$1"; shift ;;
  esac
done

count=0
spin='⠋⠙⠹⠸⠼⠴⠦⠧⠇⠏'

$quiet || printf "Waiting for connection  "

while ! curl -s --connect-timeout 2 1.1.1.1 >/dev/null 2>&1; do
  ((count++))
  if ((count >= timeout)); then
    $quiet || printf "\r\033[K✗ Timed out after %ds\n" "$timeout"
    exit 1
  fi
  $quiet || printf "\b%s" "${spin:$((count%10)):1}"
  sleep 1
done

$quiet || printf "\r\033[K✓ Online after %ds\n" "$count"
$quiet || osascript -e 'display notification "Internet accessible" with title "Network Status"' 2>/dev/null

exit 0
